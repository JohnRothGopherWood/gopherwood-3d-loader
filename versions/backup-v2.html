<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GopherWood 3D Trailer Loading System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        #controls {
            width: 350px;
            background: #f0f0f0;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        
        #scene-container {
            flex: 1;
            position: relative;
        }
        
        h2 {
            margin-top: 0;
            color: #333;
        }
        
        .control-group {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 5px;
        }
        
        button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        button:hover {
            background: #45a049;
        }

        button.active {
            background: #2E7D32;
        }
        
        select, input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        
        .stats {
            background: #fff;
            padding: 10px;
            border-radius: 5px;
        }
        
        .stat-line {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }

        input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }

        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 8px;
            border-radius: 3px;
            margin: 5px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div id="controls">
        <h2>ðŸš› GopherWood 3D Loader</h2>
        
        <div class="control-group">
            <h3>Trailer</h3>
            <button id="btn48" onclick="setTrailerSize(48)">48' Trailer</button>
            <button id="btn53" onclick="setTrailerSize(53)" class="active">53' Trailer</button>
        </div>

        <div class="control-group">
            <h3>Load Type</h3>
            <div class="checkbox-group">
                <input type="checkbox" id="mixedLoad" onchange="toggleMixedLoad()">
                <label for="mixedLoad"><strong>Mixed Load</strong> (Reserve Odd Pickets)</label>
            </div>
        </div>
        
        <div class="control-group">
            <h3>Load Bundles</h3>
            <select id="productType">
                <option value="pickets">6' Dogear Pickets (1,400 lbs)</option>
                <option value="4x4">4x4x8 Rough (816 lbs)</option>
                <option value="2x4">2x4x8 Rough (918 lbs)</option>
            </select>
            <input type="number" id="bundleCount" value="1" min="1" max="50">
            <button onclick="loadBundles()">Load Bundles</button>
            <button onclick="clearAll()">Clear Trailer</button>
        </div>

        <div class="control-group">
            <h3>Quick Actions</h3>
            <button onclick="loadMixedScenario()"><strong>Mixed:</strong> 17P + 8Posts + 14R</button>
            <button onclick="loadReservedPickets()">Load Reserved Pickets</button>
            <button onclick="loadFullPickets()">Full Picket Load</button>
        </div>
        
        <div class="control-group">
            <h3>Statistics</h3>
            <div class="stats">
                <div class="stat-line">
                    <span>Total Weight:</span>
                    <span id="totalWeight">0 lbs</span>
                </div>
                <div class="stat-line">
                    <span>Bundle Count:</span>
                    <span id="bundleCount2">0</span>
                </div>
                <div class="stat-line">
                    <span>Trailer Size:</span>
                    <span id="trailerSize">53'</span>
                </div>
                <div class="stat-line">
                    <span>Reserved Pickets:</span>
                    <span id="reservedCount">0</span>
                </div>
            </div>
        </div>

        <div id="messages"></div>
    </div>
    
    <div id="scene-container"></div>
    
    <script>
        // Global variables - EXACTLY as your working version
        let scene, camera, renderer;
        let trailer = null;
        let bundles = [];
        let trailerLength = 53;
        let totalWeight = 0;

        // NEW: Mixed load variables (minimal addition)
        let mixedLoadMode = false;
        let reservedPicketPositions = [];

        // NEW: Positioning constants from handoff document + Real GopherWood specs
        const PICKET_START = -23.5;
        const LUMBER_GAP = 3.2;
        const TIEDOWN_X = 26.5;
        const BUNDLE_SPACING = 0.8;

        /* REAL GOPHERWOOD BUNDLE SPECIFICATIONS:
         * 
         * PICKET BUNDLES: 47" W x 47" H x 72" L (3.92' x 3.92' x 6')
         * - Weight: 1,400 lbs per bundle
         * - Max stacking: 2 high x 2 across on trailer deck
         * 
         * POST BUNDLES (4x4x8): 42" W x 17" H x 96" L (3.5' x 1.42' x 8') 
         * - Weight: 816 lbs per bundle
         * - Max stacking: 5 high x 2 across on trailer deck
         * 
         * RUNNER BUNDLES (2x4x8): 42" W x 17" H x 96" L (3.5' x 1.42' x 8')
         * - Weight: 918 lbs per bundle  
         * - Max stacking: 5 high x 2 across on trailer deck
         */

        function showMessage(message) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'success';
            messageDiv.textContent = message;
            messagesDiv.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 4000);
        }
        
        // Initialize Three.js - YOUR EXACT WORKING CODE
        function init() {
            // Create scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x87CEEB);
            
            // Create camera
            const aspect = window.innerWidth / window.innerHeight;
            camera = new THREE.PerspectiveCamera(60, aspect, 0.1, 1000);
            camera.position.set(60, 40, 60);
            camera.lookAt(0, 0, 0);
            
            // Create renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            const container = document.getElementById('scene-container');
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);
            
            // Add lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.4);
            directionalLight.position.set(50, 50, 50);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            // Create ground (asphalt)
            const groundGeometry = new THREE.PlaneGeometry(200, 200);
            const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x333333 });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -0.1;
            ground.receiveShadow = true;
            scene.add(ground);
            
            // Create initial trailer
            createTrailer();
            
            // Add mouse controls
            setupControls();
            
            // Start animation
            animate();
        }
        
        // Create trailer - YOUR EXACT WORKING CODE with minimal additions
        function createTrailer() {
            // Remove old trailer if exists
            if (trailer) {
                scene.remove(trailer);
            }
            
            trailer = new THREE.Group();
            
            // Trailer deck (aluminum)
            const deckGeometry = new THREE.BoxGeometry(trailerLength, 1, 8.5);
            const deckMaterial = new THREE.MeshLambertMaterial({ color: 0xC0C0C0 });
            const deck = new THREE.Mesh(deckGeometry, deckMaterial);
            deck.position.y = 0.5;
            deck.castShadow = true;
            deck.receiveShadow = true;
            trailer.add(deck);
            
            // Add stake pockets
            const pocketGeometry = new THREE.BoxGeometry(0.5, 1, 0.5);
            const pocketMaterial = new THREE.MeshLambertMaterial({ color: 0x444444 });
            
            for (let i = -trailerLength/2 + 4; i < trailerLength/2; i += 8) {
                // Left side pockets
                const leftPocket = new THREE.Mesh(pocketGeometry, pocketMaterial);
                leftPocket.position.set(i, 1, -4);
                trailer.add(leftPocket);
                
                // Right side pockets
                const rightPocket = new THREE.Mesh(pocketGeometry, pocketMaterial);
                rightPocket.position.set(i, 1, 4);
                trailer.add(rightPocket);
            }
            
            // DOT bumper
            const bumperGeometry = new THREE.BoxGeometry(9, 1, 0.5);
            const bumperMaterial = new THREE.MeshLambertMaterial({ color: 0xFF0000 });
            const bumper = new THREE.Mesh(bumperGeometry, bumperMaterial);
            bumper.position.set(trailerLength/2 + 0.5, 0.5, 0);
            trailer.add(bumper);

            // NEW: Add tie-down marker (simple addition)
            const tiedownGeometry = new THREE.CylinderGeometry(0.3, 0.3, 1.5);
            const tiedownMaterial = new THREE.MeshLambertMaterial({ color: 0xff0000 });
            const tiedown = new THREE.Mesh(tiedownGeometry, tiedownMaterial);
            tiedown.position.set(TIEDOWN_X, 1.5, 0);
            trailer.add(tiedown);
            
            scene.add(trailer);
        }
        
        // Load bundles function - ENHANCED but keeping your structure
        function loadBundles() {
            const type = document.getElementById('productType').value;
            const count = parseInt(document.getElementById('bundleCount').value);
            
            if (type === 'pickets') {
                loadPicketBundles(count);
            } else {
                // Posts and Runners: Stack properly on/next to existing bundles
                if (type === '4x4') {
                    loadPostBundles(count);
                } else if (type === '2x4') {
                    loadRunnerBundles(count);
                }
            }
            
            updateStats();
            showMessage(`Loaded ${count} ${type} bundles`);
        }

        // NEW: Load picket bundles with proper 2x2 stacking and mixed load support
        function loadPicketBundles(count) {
            let loaded = 0;
            let currentX = PICKET_START;
            
            if (mixedLoadMode) {
                // In mixed load: load even number of bundles, reserve 1 for later
                const bundlesToLoadNow = count - 1; // Reserve the last bundle
                
                for (let i = 0; i < bundlesToLoadNow; i++) {
                    const bundle = createBundle('pickets');
                    if (bundle) {
                        const position = calculatePicketPosition(i);
                        bundle.position.set(position.x, position.y, position.z);
                        trailer.add(bundle);
                        bundles.push(bundle);
                        totalWeight += 1400;
                        loaded++;
                    }
                }
                
                // Reserve the last bundle position (will be placed at rear after lumber)
                reservedPicketPositions = [1]; // Flag that we have 1 reserved bundle
                document.getElementById('reservedCount').textContent = '1';
                
            } else {
                // Load all pickets with proper 2x2 stacking
                for (let i = 0; i < count; i++) {
                    const bundle = createBundle('pickets');
                    if (bundle) {
                        const position = calculatePicketPosition(i);
                        bundle.position.set(position.x, position.y, position.z);
                        trailer.add(bundle);
                        bundles.push(bundle);
                        totalWeight += 1400;
                        loaded++;
                    }
                }
            }
        }

        // NEW: Calculate proper picket positions (2 high x 2 across stacking)
        function calculatePicketPosition(index) {
            // Pickets stack: 2 across (left/right) x 2 high = 4 per "group", then move forward
            const groupIndex = Math.floor(index / 4);  // Which group of 4
            const posInGroup = index % 4;              // Position within the group (0-3)
            
            const side = posInGroup % 2;               // 0 = left, 1 = right  
            const level = Math.floor(posInGroup / 2);  // 0 = bottom, 1 = top
            
            return {
                x: PICKET_START + (groupIndex * 6.5),  // FIXED: Tighter spacing - 6.5' between groups
                y: 1 + (level * 4),                    // Stack height (4' per level)
                z: side === 0 ? -2 : 2                 // Left (-2') or right (+2')
            };
        }
        
        // Create bundle mesh - UPDATED WITH REAL GOPHERWOOD DIMENSIONS
        function createBundle(type) {
            let geometry, material;
            
            if (type === 'pickets') {
                // Picket bundles: 47" wide x 47" tall x 72" long = 3.92' x 3.92' x 6'
                geometry = new THREE.BoxGeometry(6, 3.92, 3.92);
            } else if (type === '4x4') {
                // Post bundles: 42" wide x 17" tall x 96" long = 3.5' x 1.42' x 8'
                geometry = new THREE.BoxGeometry(8, 1.42, 3.5);
            } else {
                // Runner bundles: 42" wide x 17" tall x 96" long = 3.5' x 1.42' x 8'
                geometry = new THREE.BoxGeometry(8, 1.42, 3.5);
            }
            
            // White wrapped bundle
            material = new THREE.MeshLambertMaterial({ color: 0xFFF8DC });
            const bundle = new THREE.Mesh(geometry, material);
            bundle.castShadow = true;
            bundle.receiveShadow = true;

            // Add metadata for positioning logic
            bundle.userData = { type: type };
            
            // Add red strapping
            const strapGeometry = new THREE.BoxGeometry(0.1, geometry.parameters.height + 0.1, geometry.parameters.depth + 0.1);
            const strapMaterial = new THREE.MeshLambertMaterial({ color: 0xFF0000 });
            
            const strap1 = new THREE.Mesh(strapGeometry, strapMaterial);
            strap1.position.x = -geometry.parameters.width/3;
            bundle.add(strap1);
            
            const strap2 = new THREE.Mesh(strapGeometry, strapMaterial);
            strap2.position.x = geometry.parameters.width/3;
            bundle.add(strap2);
            
            return bundle;
        }
        
        // Calculate position for bundles - UPDATED WITH REAL STACKING CONSTRAINTS
        function calculatePosition(index, bundleType = 'lumber') {
            if (bundleType === 'pickets') {
                // Pickets: Max 2 high x 2 across (47" x 47" x 72")
                const row = Math.floor(index / 4);  // 2 wide x 2 high = 4 per row
                const pos = index % 4;
                const side = pos % 2;  // 0 = left (-2'), 1 = right (+2')
                const stack = Math.floor(pos / 2);  // 0 = bottom, 1 = top (max 2 high)
                
                return {
                    x: -trailerLength/2 + 5 + (row * 7),  // 7' spacing between rows
                    y: 2 + (stack * 4),  // 4' vertical spacing for picket stacks
                    z: side === 0 ? -2 : 2  // Left/right positioning
                };
            } else {
                // Posts/Runners: Max 5 high x 2 across (42" x 17" x 96") 
                const row = Math.floor(index / 10);  // 2 wide x 5 high = 10 per row
                const pos = index % 10;
                const side = pos % 2;  // 0 = left, 1 = right
                const stack = Math.floor(pos / 2);  // 0-4 (max 5 high)
                
                return {
                    x: -trailerLength/2 + 5 + (row * 9),  // 9' spacing for 8' bundles
                    y: 1 + (stack * 1.5),  // 1.5' vertical spacing for post/runner stacks
                    z: side === 0 ? -2 : 2
                };
            }
        }

        // NEW: Load reserved pickets (in mixed load, place the 17th bundle at rear)
        function loadReservedPickets() {
            if (reservedPicketPositions.length === 0) {
                showMessage("No reserved pickets to load");
                return;
            }

            // In mixed load mode, place the reserved bundle at the rear of trailer
            const bundle = createBundle('pickets');
            if (bundle) {
                // Position at rear of trailer, centered
                const rearX = TIEDOWN_X - 3; // 3 feet forward of tie-down point
                bundle.position.set(rearX, 1, 0); // Centered (z=0)
                bundle.userData = { type: 'pickets', reserved: true };
                trailer.add(bundle);
                bundles.push(bundle);
                totalWeight += 1400;
            }
            
            reservedPicketPositions = [];
            document.getElementById('reservedCount').textContent = '0';
            
            updateStats();
            showMessage(`Loaded reserved picket at rear of trailer`);
        }

        // NEW: Mixed scenario quick-load
        function loadMixedScenario() {
            clearAll();
            mixedLoadMode = true;
            document.getElementById('mixedLoad').checked = true;
            
            // Step 1: Load 17 pickets
            setTimeout(() => {
                document.getElementById('productType').value = 'pickets';
                document.getElementById('bundleCount').value = '17';
                loadBundles();
            }, 100);
            
            // Step 2: Load 8 posts  
            setTimeout(() => {
                document.getElementById('productType').value = '4x4';
                document.getElementById('bundleCount').value = '8';
                loadBundles();
            }, 800);
            
            // Step 3: Auto-load reserved pickets
            setTimeout(() => {
                loadReservedPickets();
            }, 1500);
            
            showMessage('Loading Mixed Scenario');
        }

        // NEW: Full picket load
        function loadFullPickets() {
            clearAll();
            mixedLoadMode = false;
            document.getElementById('mixedLoad').checked = false;
            
            document.getElementById('productType').value = 'pickets';
            document.getElementById('bundleCount').value = '50';
            loadBundles();
        }

        // NEW: Toggle mixed load mode
        function toggleMixedLoad() {
            mixedLoadMode = document.getElementById('mixedLoad').checked;
            if (mixedLoadMode) {
                showMessage('Mixed Load Mode: Will reserve odd picket positions');
            } else {
                showMessage('Normal Load Mode: Sequential loading');
            }
        }
        
        // Clear all bundles - YOUR EXACT WORKING CODE with minor additions
        function clearAll() {
            bundles.forEach(bundle => {
                trailer.remove(bundle);
            });
            bundles = [];
            reservedPicketPositions = [];
            totalWeight = 0;
            updateStats();
            showMessage('Trailer cleared');
        }
        
        // Set trailer size - YOUR EXACT WORKING CODE with button state management
        function setTrailerSize(size) {
            trailerLength = size;
            clearAll();
            createTrailer();
            document.getElementById('trailerSize').textContent = size + "'";
            
            // Update button states
            document.getElementById('btn48').classList.toggle('active', size === 48);
            document.getElementById('btn53').classList.toggle('active', size === 53);
        }
        
        // Update statistics - YOUR EXACT WORKING CODE with reserved count
        function updateStats() {
            document.getElementById('totalWeight').textContent = totalWeight.toLocaleString() + ' lbs';
            document.getElementById('bundleCount2').textContent = bundles.length;
            document.getElementById('reservedCount').textContent = reservedPicketPositions.length;
        }
        
        // Setup mouse controls - YOUR EXACT WORKING CODE
        function setupControls() {
            let mouseDown = false;
            let mouseX = 0;
            let mouseY = 0;
            
            document.addEventListener('mousedown', (e) => {
                mouseDown = true;
                mouseX = e.clientX;
                mouseY = e.clientY;
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!mouseDown) return;
                
                const deltaX = e.clientX - mouseX;
                const deltaY = e.clientY - mouseY;
                
                const rotation = trailer.rotation.y + deltaX * 0.01;
                trailer.rotation.y = rotation;
                
                mouseX = e.clientX;
                mouseY = e.clientY;
            });
            
            document.addEventListener('mouseup', () => {
                mouseDown = false;
            });
            
            document.addEventListener('wheel', (e) => {
                const scale = camera.position.length();
                const newScale = scale + e.deltaY * 0.05;
                if (newScale > 20 && newScale < 200) {
                    camera.position.multiplyScalar(newScale / scale);
                }
            });
        }
        
        // Animation loop - YOUR EXACT WORKING CODE
        function animate() {
            requestAnimationFrame(animate);
            camera.lookAt(0, 0, 0);
            renderer.render(scene, camera);
        }
        
        // Window resize handler - YOUR EXACT WORKING CODE
        window.addEventListener('resize', () => {
            const container = document.getElementById('scene-container');
            if (camera && renderer) {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            }
        });
        
        // Start the application - YOUR EXACT WORKING CODE
        window.onload = init;
    </script>
</body>
</html>
